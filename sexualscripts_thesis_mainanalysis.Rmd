---
title: "Sexual Scripts Master Thesis Main Analysis"
author: "Fanny Habacht"
date: "2023-03-06"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


This code includes the main analysis of my master thesis, including factor analyses and network models.


# Packages
```{r}

packages <- c('stats', 'readr', 'dplyr', 'ggplot2', 'psych', 'lavaan', 'semPlot', 'semTable', 'IsingFit', 'qgraph', 'psychonetrics', 'EGAnet', 'EFAtools', 'missMethods', 'norm')

lapply(packages, library, character.only = TRUE)

```


# Data
```{r}

data <- read_csv('data_sexualscript_hetero_malefemale.csv')


data_hetero_malefemale <- data %>% 
  select(
    -'consent',
    -'duration',
    -'age',
    -'sexuality',
    -'monogamy',
    -'nb_gender_attraction'
  )


# missing values

sum(
  is.na(data_hetero_malefemale)
)


# impute missing values

set.seed(9191)

data_hetero_malefemale <- impute_EM(data_hetero_malefemale,stochastic = FALSE)

write.csv(data_hetero_malefemale, 'data_sexualscript_mainanalysis.csv', row.names = FALSE)


# check the class of each column

sapply(data_hetero_malefemale, class) 


```


# Factor Analyses

## Ammsa measurement model
```{r}

# model specification

ammsa_cfa <- ('
                
                ammsa =~ ammsa_1 + ammsa_2 + ammsa_3 + ammsa_4 + ammsa_5 + ammsa_6 + ammsa_7 + ammsa_8 + ammsa_9 + ammsa_10 + ammsa_11 + ammsa_12 + ammsa_13 + ammsa_14 + ammsa_15 + ammsa_16 + ammsa_17 + ammsa_18 + ammsa_19 + ammsa_20 + ammsa_21
                
                ')


# model fitting

if (!file.exists('./rda/ammsa_cfa_fit.rda')) {
  
  ammsa_cfa_fit <- cfa(
    model = ammsa_cfa,
    data = data_hetero_malefemale,
    se = 'bootstrap',
    bootstrap = 5000,
    meanstructure = TRUE
    )
  
  save(ammsa_cfa_fit, file = './rda/ammsa_cfa_fit.rda')
  
} else {
  
  load('./rda/ammsa_cfa_fit.rda')
  
}

# summary of fit

summary(ammsa_cfa_fit, fit.measures = TRUE, standardize = TRUE)


```


### Ammsa measurement model visualizations
```{r}

table_ammsa_cfa_fit <- semTable(
  ammsa_cfa_fit, 
  file = './tables/table_ammsa_cfa_fit',
  paramSets = c('loadings', 'slopes', 'intercepts', 'residualvariances'), 
  columns = c(est = "Estimate", se = "SE", p = "p"),
  fits = c("chisq", "cfi", "tli", "rmsea", "srmr"), 
  type = "html",
  table.float = TRUE,
  longtable = TRUE, 
  print.results = TRUE,
  alpha = c(0.05, 0.01, 0.001)
)

```

```{r}

figure_ammsa_cfa_fit <- semPaths(
  object = ammsa_cfa_fit,
  whatLabels = 'std',
  intercepts = FALSE,
  curvePivot = TRUE, # making curved arrows
  esize = 1, # thickness of arrows
  nCharNodes = 8, # uses 8 characters of the name in the boxes
  edge.label.cex = 1,
  residuals = FALSE, # does not show the error terms/residuals
  sizeMan = 5, # width of manifest var box
  sizeLat = 10,
  layout = 'circle',
  nodeLabels = c(1:21, 'AMMSA-21'),
  groups = 'latents',
  color = '#D9ACED'
)

```


### Ammsa measurement invariance
```{r}

if (!file.exists('./rda/ammsa_cfa_invar_1.rda')) {
  
  
  # configural invariance
  
  ammsa_cfa_invar_1 <- cfa(ammsa_cfa,
                           data = data_hetero_malefemale %>% 
                             select(starts_with('ammsa'), 'gender'),
                           se = 'bootstrap',
                           bootstrap = 5000,
                           group = 'gender',
                           meanstructure = TRUE)
  
  # weak invariance
  
  ammsa_cfa_invar_2 <- cfa(ammsa_cfa,
                           data = data_hetero_malefemale %>% 
                             select(starts_with('ammsa'), 'gender'),
                           se = 'bootstrap',
                           bootstrap = 5000,
                           group = 'gender',
                           group.equal = 'loadings',
                           meanstructure = TRUE)
  
  # strong invariance
  
  ammsa_cfa_invar_3 <- cfa(ammsa_cfa,
                           data = data_hetero_malefemale %>% 
                             select(starts_with('ammsa'), 'gender'),
                           se = 'bootstrap',
                           bootstrap = 5000,
                           group = 'gender',
                           group.equal = c('loadings', 'intercepts'),
                           meanstructure = TRUE)
  
  # strict invariance
  
  ammsa_cfa_invar_4 <- cfa(ammsa_cfa,
                           data = data_hetero_malefemale %>% 
                             select(starts_with('ammsa'), 'gender'),
                           se = 'bootstrap',
                           bootstrap = 5000,
                           group = 'gender',
                           group.equal = c('loadings', 'intercepts', 'residuals'),
                           meanstructure = TRUE)
  
  
  save(ammsa_cfa_invar_1, file = './rda/ammsa_cfa_invar_1.rda')
  save(ammsa_cfa_invar_2, file = './rda/ammsa_cfa_invar_2.rda')
  save(ammsa_cfa_invar_3, file = './rda/ammsa_cfa_invar_3.rda')
  save(ammsa_cfa_invar_4, file = './rda/ammsa_cfa_invar_4.rda')

} else {
  
  load('./rda/ammsa_cfa_invar_1.rda')
  load('./rda/ammsa_cfa_invar_2.rda')
  load('./rda/ammsa_cfa_invar_3.rda')
  load('./rda/ammsa_cfa_invar_4.rda')
  
}


fitind_ammsa_cfa_invar_1 <- fitmeasures(ammsa_cfa_invar_1)
fitind_ammsa_cfa_invar_2 <- fitmeasures(ammsa_cfa_invar_2)
fitind_ammsa_cfa_invar_3 <- fitmeasures(ammsa_cfa_invar_3)
fitind_ammsa_cfa_invar_4 <- fitmeasures(ammsa_cfa_invar_4)

fitind_ammsa_cfa_invar_1
fitind_ammsa_cfa_invar_2
fitind_ammsa_cfa_invar_3
fitind_ammsa_cfa_invar_4

# comparing invariance models

anova(ammsa_cfa_invar_1, ammsa_cfa_invar_2, ammsa_cfa_invar_3, ammsa_cfa_invar_4)

```


## Sexual Scripts Sakaluk 1-factor model
```{r}

# model specification

sakaluk_cfa_1factor <- ('
                
                sexualscripts_sakaluk =~ sexualstandards_1 + sexualstandards _2 + sexualstandards _3 + sexualstandards _4 + sexualstandards _5 + sexualstandards _6 + sexualstandards _7 + sexualstandards _8 + sexualstandards _9 + complexity_1 + complexity_2 + complexity_3 + complexity_4 + complexity_5 + complexity_6 + complexity_7 + sexdrive_1 + sexdrive_2 + sexdrive_3 + sexdrive_4 + sexdrive_5 + performanceandorgasm_1 + performanceandorgasm_2 + performanceandorgasm_3 + performanceandorgasm_4 + player_1 + player_2 + player_3 + player_4 + emotionalsex_1 + emotionalsex_2 + emotionalsex_3
                
                ')


# model fitting

if (!file.exists('./rda/sakaluk_cfa_1factor_fit.rda')) {
  
  sakaluk_cfa_1factor_fit <- cfa(
    model = sakaluk_cfa_1factor,
    data = data_hetero_malefemale,
    se = 'bootstrap',
    bootstrap = 5000,
    meanstructure = TRUE
    )
  
  save(sakaluk_cfa_1factor_fit, file = './rda/sakaluk_cfa_1factor_fit.rda')
  
} else {
  
  load('./rda/sakaluk_cfa_1factor_fit.rda')
  
}


# summary of fit

summary(sakaluk_cfa_1factor_fit, fit.measures = TRUE, standardize = TRUE)


```


### Sexual Scripts Sakaluk 1-factor model visualizations
```{r}

table_sakaluk_cfa_1factor_fit <- semTable(
  sakaluk_cfa_1factor_fit, 
  file = './tables/table_sakaluk_cfa_1factor_fit',
  paramSets = c('loadings', 'slopes', 'intercepts', 'residualvariances'), 
  columns = c(est = "Estimate", se = "SE", p = "p"),
  fits = c("chisq", "cfi", "tli", "rmsea", "srmr"), 
  type = "html",
  table.float = TRUE,
  longtable = TRUE, 
  print.results = TRUE,
  alpha = c(0.05, 0.01, 0.001)
)

```

```{r}

figure_sakaluk_cfa_1factor_fit <- semPaths(
  object = sakaluk_cfa_1factor_fit,
  whatLabels = 'std',
  intercepts = FALSE,
  curvePivot = TRUE, # making curved arrows
  esize = 1, # thickness of arrows
  nCharNodes = 8, # uses 8 characters of the name in the boxes
  edge.label.cex = 0.75,
  residuals = FALSE, # does not show the error terms/residuals
  sizeMan = 5, # width of manifest var box
  sizeLat = 10,
  layout = 'circle'
)

```


## Sexual Scripts Sakaluk 6-factor model
```{r}

# model specification

sakaluk_cfa_6factor <- ('
                
                # latent variables
                
                sexualstandards =~ sexualstandards_1 + sexualstandards _2 + sexualstandards _3 + sexualstandards _4 + sexualstandards _5 + sexualstandards _6 + sexualstandards _7 + sexualstandards _8 + sexualstandards _9
                
                complexity =~ complexity_1 + complexity_2 + complexity_3 + complexity_4 + complexity_5 + complexity_6 + complexity_7
                
                sexdrive =~ sexdrive_1 + sexdrive_2 + sexdrive_3 + sexdrive_4 + sexdrive_5
                
                performanceandorgasm =~ performanceandorgasm_1 + performanceandorgasm_2 + performanceandorgasm_3 + performanceandorgasm_4
                
                player =~ player_1 + player_2 + player_3 + player_4
                
                emotionalsex =~ emotionalsex_1 + emotionalsex_2 + emotionalsex_3
                
                
                # covariates
                
                sexualstandards ~~ complexity
                sexualstandards ~~ sexdrive
                sexualstandards ~~ performanceandorgasm
                sexualstandards ~~ player
                sexualstandards ~~ emotionalsex
                
                complexity ~~ sexdrive
                complexity ~~ performanceandorgasm
                complexity ~~ player
                complexity ~~ emotionalsex
                
                sexdrive ~~ performanceandorgasm
                sexdrive ~~ player
                sexdrive ~~ emotionalsex
                
                performanceandorgasm ~~ player
                performanceandorgasm ~~ emotionalsex
                
                player ~~ emotionalsex
                
                ')


# model fitting

if (!file.exists('./rda/sakaluk_cfa_6factor_fit.rda')) {
  
  sakaluk_cfa_6factor_fit <- cfa(
    model = sakaluk_cfa_6factor,
    data = data_hetero_malefemale,
    se = 'bootstrap',
    bootstrap = 5000,
    meanstructure = TRUE
    )
  
  save(sakaluk_cfa_6factor_fit, file = './rda/sakaluk_cfa_6factor_fit.rda')
  
} else {
  
  load('./rda/sakaluk_cfa_6factor_fit.rda')
  
}


# summary of fit

summary(sakaluk_cfa_6factor_fit, fit.measures = TRUE, standardize = TRUE)


```


### Sexual Scripts Sakaluk 6-factor model visualizations
```{r}

table_sakaluk_cfa_6factor_fit <- semTable(
  sakaluk_cfa_6factor_fit, 
  file = './tables/table_sakaluk_cfa_6factor_fit',
  paramSets = c('loadings', 'slopes', 'intercepts', 'residualvariances'), 
  columns = c(est = "Estimate", se = "SE", p = "p"),
  fits = c("chisq", "cfi", "tli", "rmsea", "srmr"), 
  type = "html",
  table.float = TRUE,
  longtable = TRUE, 
  print.results = TRUE,
  alpha = c(0.05, 0.01, 0.001)
)

```

```{r}

figure_sakaluk_cfa_6factor_fit <- semPaths(
  object = sakaluk_cfa_6factor_fit,
  whatLabels = 'std',
  nodeLabels = c('SS1', 'SS2', 'SS3', 'SS4', 'SS5', 'SS6', 'SS7', 'SS8', 'SS9', 'SC1', 'SC2', 'SC3', 'SC4', 'SC5', 'SC6', 'SC7', 'SD1', 'SD2', 'SD3', 'SD4', 'SD5', 'PO1', 'PO2', 'PO3', 'PO4', 'P1', 'P2' , 'P3', 'P4', 'ES1', 'ES2', 'ES3', 'SS', 'SC', 'SD', 'PO', 'P', 'ES'),
  intercepts = FALSE,
  curvePivot = TRUE, # making curved arrows
  esize = 1, # thickness of arrows
  nCharNodes = 8, # uses 8 characters of the name in the boxes
  edge.label.cex = 0.75,
  residuals = FALSE, # does not show the error terms/residuals
  sizeMan = 5.5, # width of manifest var box
  sizeLat = 7,
  layout = 'circle2',
  groups = 'latents',
  color = c('#D9ACED', 'pink', '#77BDE7', '#96F3C0', '#F3E196', '#67A175')
)

```


## Sexual Scripts Sakaluk 1-factor and 6-factor model comparison
```{r}

anova(sakaluk_cfa_1factor_fit, sakaluk_cfa_6factor_fit)


```


### Sexual Scripts Sakaluk 6-factor model measurement invariance
```{r}

if (!file.exists('./rda/sakaluk_cfa_6factor_invar_1.rda')) {
  
  
  # configural invariance
  
  sakaluk_cfa_6factor_invar_1 <- cfa(sakaluk_cfa_6factor,
                                     data = data_hetero_malefemale %>% 
                                       select(
                                         starts_with('sexualstandards'),
                                         starts_with('complexity'),
                                         starts_with('sexdrive'),
                                         starts_with('performanceandorgasm'),
                                         starts_with('player'),
                                         starts_with('emotionalsex'),
                                         'gender'),
                                     se = 'bootstrap',bootstrap = 5000,
                                     group = 'gender',
                                     meanstructure = TRUE)
  
  # weak invariance
  
  sakaluk_cfa_6factor_invar_2 <- cfa(sakaluk_cfa_6factor,
                                     data = data_hetero_malefemale %>% 
                                       select(
                                         starts_with('sexualstandards'),
                                         starts_with('complexity'),
                                         starts_with('sexdrive'),
                                         starts_with('performanceandorgasm'),
                                         starts_with('player'),
                                         starts_with('emotionalsex'),
                                         'gender'),
                                     se = 'bootstrap',bootstrap = 5000,
                                     group = 'gender',
                                     group.equal = 'loadings',
                                     meanstructure = TRUE)
  
  # strong invariance
  
  sakaluk_cfa_6factor_invar_3 <- cfa(sakaluk_cfa_6factor,
                                     data = data_hetero_malefemale %>% 
                                       select(
                                         starts_with('sexualstandards'),
                                         starts_with('complexity'),
                                         starts_with('sexdrive'),
                                         starts_with('performanceandorgasm'),
                                         starts_with('player'),
                                         starts_with('emotionalsex'),
                                         'gender'),
                                     se = 'bootstrap',bootstrap = 5000,
                                     group = 'gender',
                                     group.equal = c('loadings', 'intercepts'),
                                     meanstructure = TRUE)
  
  # strict invariance
  
  sakaluk_cfa_6factor_invar_4 <- cfa(sakaluk_cfa_6factor,
                                     data = data_hetero_malefemale %>% 
                                       select(
                                         starts_with('sexualstandards'),
                                         starts_with('complexity'),
                                         starts_with('sexdrive'),
                                         starts_with('performanceandorgasm'),
                                         starts_with('player'),
                                         starts_with('emotionalsex'),
                                         'gender'),
                                     se = 'bootstrap',bootstrap = 5000,
                                     group = 'gender',
                                     group.equal = c('loadings', 'intercepts', 'residuals'),
                                     meanstructure = TRUE)
  
  
  save(sakaluk_cfa_6factor_invar_1, file = './rda/sakaluk_cfa_6factor_invar_1.rda')
  save(sakaluk_cfa_6factor_invar_2, file = './rda/sakaluk_cfa_6factor_invar_2.rda')
  save(sakaluk_cfa_6factor_invar_3, file = './rda/sakaluk_cfa_6factor_invar_3.rda')
  save(sakaluk_cfa_6factor_invar_4, file = './rda/sakaluk_cfa_6factor_invar_4.rda')

} else {
  
  load('./rda/sakaluk_cfa_6factor_invar_1.rda')
  load('./rda/sakaluk_cfa_6factor_invar_2.rda')
  load('./rda/sakaluk_cfa_6factor_invar_3.rda')
  load('./rda/sakaluk_cfa_6factor_invar_4.rda')
  
}


fitind_sakaluk_cfa_6factor_invar_1 <- fitmeasures(sakaluk_cfa_6factor_invar_1)
fitind_sakaluk_cfa_6factor_invar_2 <- fitmeasures(sakaluk_cfa_6factor_invar_2)
fitind_sakaluk_cfa_6factor_invar_3 <- fitmeasures(sakaluk_cfa_6factor_invar_3)
fitind_sakaluk_cfa_6factor_invar_4 <- fitmeasures(sakaluk_cfa_6factor_invar_4)


# comparing invariance models

anova(sakaluk_cfa_6factor_invar_1, sakaluk_cfa_6factor_invar_2, sakaluk_cfa_6factor_invar_3, sakaluk_cfa_6factor_invar_4)

```


## Sexual Scripts Seabrook 4-factor model
```{r}

# model specification

seabrook_cfa_4factor <- ('
                
                # latent variables
                
                courtship =~ courtship_1 + courtship_2 + courtship_3 + courtship_4 + courtship_5 + courtship_6 + courtship_7 + courtship_8
                
                initiators =~ initiators_1 + initiators_2 + initiators_3 + initiators_4
                
                appearance =~ appearance_1 + appearance_2 + appearance_3 + appearance_4 + appearance_5
                
                doublestandards =~ doublestandards_1 + doublestandards_2 + doublestandards_3 + doublestandards_4 + doublestandards_5
                
                
                # covariates 
                
                courtship ~~ initiators
                courtship ~~ appearance
                courtship ~~ doublestandards
                
                initiators ~~ appearance
                initiators ~~ doublestandards
                
                appearance ~~ doublestandards
                
                ')


# model fitting

if (!file.exists('./rda/seabrook_cfa_4factor_fit.rda')) {
  
  seabrook_cfa_4factor_fit <- cfa(
    model = seabrook_cfa_4factor,
    data = data_hetero_malefemale,
    se = 'bootstrap',
    bootstrap = 5000,
    meanstructure = TRUE
    )
  
  save(seabrook_cfa_4factor_fit, file = './rda/seabrook_cfa_4factor_fit.rda')
  
} else {
  
  load('./rda/seabrook_cfa_4factor_fit.rda')
  
}


# summary of fit

summary(seabrook_cfa_4factor_fit, fit.measures = TRUE, standardize = TRUE)

```


### Sexual Scripts Seabrook 4-factor model visualizations
```{r}

table_seabrook_cfa_4factor_fit <- semTable(
  seabrook_cfa_4factor_fit, 
  file = './tables/table_seabrook_cfa_4factor_fit',
  paramSets = c('loadings', 'slopes', 'intercepts', 'residualvariances'), 
  columns = c(est = "Estimate", se = "SE", p = "p"),
  fits = c("chisq", "cfi", "tli", "rmsea", "srmr"), 
  type = "html",
  table.float = TRUE,
  longtable = TRUE, 
  print.results = TRUE,
  alpha = c(0.05, 0.01, 0.001)
)

```

```{r}

figure_seabrook_cfa_4factor_fit <- semPaths(
  object = seabrook_cfa_4factor_fit,
  whatLabels = 'std',
  intercepts = FALSE,
  curvePivot = TRUE, # making curved arrows
  esize = 1, # thickness of arrows
  nCharNodes = 8, # uses 8 characters of the name in the boxes
  edge.label.cex = 0.75,
  residuals = FALSE, # does not show the error terms/residuals
  sizeMan = 6, # width of manifest var box
  sizeLat = 7,
  layout = 'circle2'
)

```


## Sexual Scripts Seabrook higher order factor model
```{r}

# model specification

seabrook_cfa_higherfactor <- ('
                
                # latent variables
                
                courtship =~ courtship_1 + courtship_2 + courtship_3 + courtship_4 + courtship_5 + courtship_6 + courtship_7 + courtship_8
                
                initiators =~ initiators_1 + initiators_2 + initiators_3 + initiators_4
                
                appearance =~ appearance_1 + appearance_2 + appearance_3 + appearance_4 + appearance_5
                
                doublestandards =~ doublestandards_1 + doublestandards_2 + doublestandards_3 + doublestandards_4 + doublestandards_5
                
                sexualscript =~ courtship + initiators + appearance + doublestandards
                
                
                # covariances
                
                courtship ~~ 0*initiators
                courtship ~~ 0*appearance
                courtship ~~ 0*doublestandards
                
                initiators ~~ 0*appearance
                initiators ~~ 0*doublestandards
                
                appearance ~~ 0*doublestandards
                
                ')


# model fitting

if (!file.exists('./rda/seabrook_cfa_higherfactor_fit.rda')) {
  
  seabrook_cfa_higherfactor_fit <- cfa(
    model = seabrook_cfa_higherfactor,
    data = data_hetero_malefemale,
    se = 'bootstrap',
    bootstrap = 5000,
    meanstructure = TRUE
    )
  
  save(seabrook_cfa_higherfactor_fit, file = './rda/seabrook_cfa_higherfactor_fit.rda')
  
} else {
  
  load('./rda/seabrook_cfa_higherfactor_fit.rda')
  
}


# summary of fit

summary(seabrook_cfa_higherfactor_fit, fit.measures = TRUE, standardize = TRUE)

```


### Sexual Scripts Seabrook higher order factor model visualizations
```{r}

table_seabrook_cfa_higherfactor_fit <- semTable(
  seabrook_cfa_higherfactor_fit, 
  file = './tables/table_seabrook_cfa_higherfactor_fit',
  paramSets = c('loadings', 'slopes', 'intercepts', 'residualvariances'), 
  columns = c(est = "Estimate", se = "SE", p = "p"),
  fits = c("chisq", "cfi", "tli", "rmsea", "srmr"), 
  type = "html",
  table.float = TRUE,
  longtable = TRUE, 
  print.results = TRUE,
  alpha = c(0.05, 0.01, 0.001)
)

```

```{r}

figure_seabrook_cfa_higherfactor_fit <- semPaths(
  object = seabrook_cfa_higherfactor_fit,
  whatLabels = 'std',
  nodeLabels = c('CC1', 'CC2', 'CC3', 'CC4', 'CC5', 'CC6', 'CC7', 'CC8', 'I1', 'I2', 'I3', 'I4', 'A1', 'A2', 'A3', 'A4', 'A5', 'DS1', 'DS2', 'DS3', 'DS4', 'DS5', 'Courtship', 'Initiators', 'Appearance', 'DoubleStandards', 'SexualScripts'),
  intercepts = FALSE,
  curvePivot = TRUE, # making curved arrows
  esize = 1, # thickness of arrows
  edge.label.cex = 0.75,
  label.cex = 1.75,
  residuals = FALSE, # does not show the error terms/residuals
  sizeMan = 3, # width of manifest var box
  sizeLat = 12,
  nCharNodes = 15, # uses 8 characters of the name in the boxes
  layout = 'tree2',
  groups = 'latents',
  color = c('#D9ACED', 'pink', '#77BDE7', '#F3E196', '#67A175')
)

```


## Sexual Scripts Seabrook 4-factor and higher order factor model comparison
```{r}

anova(seabrook_cfa_4factor_fit, seabrook_cfa_higherfactor_fit)

```


### Sexual Scripts Seabrook higher order factor model measurement invariance
```{r}

if (!file.exists('./rda/seabrook_cfa_higherfactor_invar_1.rda')) {
  
  
  # configural invariance
  
  seabrook_cfa_higherfactor_invar_1 <- cfa(seabrook_cfa_higherfactor,
                                       data = data_hetero_malefemale %>% 
                                        select(
                                          starts_with('courtship'),
                                          starts_with('initiators'),
                                          starts_with('appearance'),
                                          starts_with('doublestandards'),
                                          'gender'),
                                      se = 'bootstrap',bootstrap = 5000,
                                      group = 'gender',
                                      meanstructure = TRUE)
  
  # weak invariance
  
  seabrook_cfa_higherfactor_invar_2 <- cfa(seabrook_cfa_higherfactor,
                                       data = data_hetero_malefemale %>% 
                                        select(
                                          starts_with('courtship'),
                                          starts_with('initiators'),
                                          starts_with('appearance'),
                                          starts_with('doublestandards'),
                                          'gender'),
                                      se = 'bootstrap',bootstrap = 5000,
                                      group = 'gender',
                                      group.equal = 'loadings',
                                      meanstructure = TRUE)
  
  # strong invariance
  
  seabrook_cfa_higherfactor_invar_3 <- cfa(seabrook_cfa_higherfactor,
                                       data = data_hetero_malefemale %>% 
                                        select(
                                          starts_with('courtship'),
                                          starts_with('initiators'),
                                          starts_with('appearance'),
                                          starts_with('doublestandards'),
                                          'gender'),
                                      se = 'bootstrap',bootstrap = 5000,
                                      group = 'gender',
                                      group.equal = c('loadings', 'intercepts'),
                                      meanstructure = TRUE)
  
  # strict invariance
  
  seabrook_cfa_higherfactor_invar_4 <- cfa(seabrook_cfa_higherfactor,
                                       data = data_hetero_malefemale %>% 
                                        select(
                                          starts_with('courtship'),
                                          starts_with('initiators'),
                                          starts_with('appearance'),
                                          starts_with('doublestandards'),
                                          'gender'),
                                      se = 'bootstrap',bootstrap = 5000,
                                      group = 'gender',
                                      group.equal = c('loadings', 'intercepts', 'residuals'),
                                      meanstructure = TRUE)
  
  
  save(seabrook_cfa_higherfactor_invar_1, file = './rda/seabrook_cfa_higherfactor_invar_1.rda')
  save(seabrook_cfa_higherfactor_invar_2, file = './rda/seabrook_cfa_higherfactor_invar_2.rda')
  save(seabrook_cfa_higherfactor_invar_3, file = './rda/seabrook_cfa_higherfactor_invar_3.rda')
  save(seabrook_cfa_higherfactor_invar_4, file = './rda/seabrook_cfa_higherfactor_invar_4.rda')

} else {
  
  load('./rda/seabrook_cfa_higherfactor_invar_1.rda')
  load('./rda/seabrook_cfa_higherfactor_invar_2.rda')
  load('./rda/seabrook_cfa_higherfactor_invar_3.rda')
  load('./rda/seabrook_cfa_higherfactor_invar_4.rda')
  
}


fitind_seabrook_cfa_higherfactor_invar_1 <- fitmeasures(seabrook_cfa_higherfactor_invar_1)
fitind_seabrook_cfa_higherfactor_invar_2 <- fitmeasures(seabrook_cfa_higherfactor_invar_2)
fitind_seabrook_cfa_higherfactor_invar_3 <- fitmeasures(seabrook_cfa_higherfactor_invar_3)
fitind_seabrook_cfa_higherfactor_invar_4 <- fitmeasures(seabrook_cfa_higherfactor_invar_4)


# comparing invariance models

anova(seabrook_cfa_higherfactor_invar_1, seabrook_cfa_higherfactor_invar_2, seabrook_cfa_higherfactor_invar_3, seabrook_cfa_higherfactor_invar_4)

```


# Sexual Scripts Krahe EFA
```{r}

data_krahe <- data_hetero_malefemale %>% 
  select(
    starts_with('arranged'), 
    starts_with('situation'), 
    starts_with('sex_'), 
    starts_with('sexlocation'), 
    starts_with('contraception'), 
    'metbefore', 
    'knownbefore',
    starts_with('substances'), 
    starts_with('drunkstoned'), 
    starts_with('consent'), 
    starts_with('afterfeeling'), 
    starts_with('outlook')
  )

```


```{r}

cormat_data_krahe <- cor(data_krahe)

det(cormat_data_krahe)

KMO(cormat_data_krahe)

BARTLETT(data_krahe)

```


```{r}

# Eigenvalues > 1 (Kaiser criterion)

ev_krahe <- eigen(cormat_data_krahe)

ev_krahe$values


# Scree Plot

scree(data_krahe, pc = FALSE)


# Parallel analysis

PARALLEL(data_krahe)

```


```{r}

efa_krahe_fit <- efa(data = data_krahe,
                     nfactors = 12, # change depending how many factors are suggested
                     sample.cov = cormat_data_krahe,
                     rotation = 'oblimin', # oblique rotation bc factors are obv related
                     output = 'efa'
                     )

summary(efa_krahe_fit)

```


# Network Model all scales
```{r}

data_networkmodel <- data_hetero_malefemale %>% 
  select(
    -'id',
    -'gender',
    -starts_with('ammsa'))


networkmodel_final <- EBICglasso(cor(data_networkmodel, use = "pairwise.complete"), returnAllResults = FALSE, nrow(data_networkmodel))

networkmodel_final_ebic <- data.frame(networkmodel_final$ebic)

networkmodel_final_lambda <- data.frame(networkmodel_final$lambda)

networkmodel_final_results <- cbind(networkmodel_final_ebic, networkmodel_final_lambda)

```


## Graph Network Model all scales
```{r}

networklabels <- c(
  'sexst_1',
  'sexst_2',
  'sexst_3',
  'sexst_4',
  'sexst_5',
  'sexst_6',
  'sexst_7',
  'sexst_8',
  'sexst_9',
  'comp_1',
  'comp_2',
  'comp_3',
  'comp_4',
  'comp_5',
  'comp_6',
  'comp_7',
  'sexd_1',
  'sexd_2',
  'sexd_3',
  'sexd_4',
  'sexd_5',
  'perf_1',
  'perf_2',
  'perf_3',
  'perf_4',
  'play_1',
  'play_2',
  'play_3',
  'play_4',
  'emse_1',
  'emse_2',
  'emse_3',
  'cour_1',
  'cour_2',
  'cour_3',
  'cour_4',
  'cour_5',
  'cour_6',
  'cour_7',
  'cour_8',
  'init_1',
  'init_2',
  'init_3',
  'init_4',
  'appe_1',
  'appe_2',
  'appe_3',
  'appe_4',
  'appe_5',
  'dost_1',
  'dost_2',
  'dost_3',
  'dost_4',
  'dost_5',
  'arra_1',
  'situ_1',
  'situ_2',
  'situ_3',
  'sex_1',
  'sex_2',
  'sex_3',
  'sex_4',
  'sex_5',
  'sexlo_1',
  'sexlo_2',
  'sexlo_3',
  'sexlo_4',
  'sexlo_5',
  'sexlo_6',
  'cont_1',
  'cont_2',
  'cont_3',
  'cont_4',
  'cont_5',
  'met_1',
  'known_1',
  'subst_1',
  'subst_2',
  'subst_3',
  'subst_4',
  'drunk_1',
  'drunk_2',
  'cboy_1',
  'cboy_2',
  'cgirl_1',
  'cgirl_2',
  'after_1',
  'after_2',
  'outg_1',
  'outg_2',
  'outg_3',
  'outb_1',
  'outb_2',
  'outb_3'
)



graph_network <- qgraph(networkmodel_final,
                        layout = 'spring',
                        theme = 'colorblind',
                        title = 'Sexual Script Network Model', 
                        edge.labels = FALSE,
                        labels = networklabels,
                        vsize = 4,
                        label.cex = 1,
                        shape = 'circle',
                        filetype = 'pdf',
                        filename = 'sexualscriptnetwork')

```


## Node Centrality 

### Centrality Plot
```{r}

graph_centrality_network <- qgraph::centralityPlot(
  graph_network,
  include = c('Strength', 'Closeness', 'Betweenness'))

```


### Strength

= sum of the absolute edge values connected to a given node;
represents direct influence the given node has on the network

```{r}

network_strength <- graph_centrality_network$data %>% # take qgraph data
  filter(measure == 'Strength') %>% # take strength data
  arrange(desc(value)) %>% # arrange largest value first
  mutate(
    node = as.numeric(node)
  )
  
```


### Betweenness

= how strongly a given node can disrupt information flow in the network;
calculates the number of shortest paths a given node lies on

```{r}

network_between <- graph_centrality_network$data %>% 
  filter(measure == "Betweenness") %>% 
  arrange(desc(value)) %>% 
  mutate(
    node = as.numeric(node)
  )

```


## Network Connectivity (ASPL)

Average of all shortest path lengths between all nodes in the network
Low length = high connectivity

```{r}

spl_network <- centrality(graph_network)$ShortestPathLengths

spl_network <- spl_network[upper.tri(spl_network)]
aspl_network <- mean(spl_network)

```


## Communities/Clusters
```{r}

# how many 'factors' would I have?

parallel_sexualscripts <- fa.parallel(data_networkmodel)

```


```{r}

set.seed(4905)

# exploratory graph analysis

ega_sexualscripts <-EGAnet::EGA(data_networkmodel,
                                model = 'glasso',
                                algorithm = 'walktrap',
                                plot.EGA = TRUE,
                                )

```


# Network Model AMMSA
```{r}

data_ammsa <- data_hetero_malefemale %>% 
  select(
    starts_with('ammsa'))

cormat_ammsa <- cor(data_ammsa)


if (!file.exists('./rda/ammsa_networkmodel.rda')) {
  
  # model the variance-covariance matrix
  networkmodel_ammsa <- varcov(data = data_ammsa,
                               type = 'ggm', # Gaussian graphical model
                               omega = 'Full', # estimate every element freely
                               optimizer = 'cpp_Nelder-Mead')


  # run model and estimate structure --> time consuming
  networkmodel_ammsa_final <- networkmodel_ammsa %>% 
    runmodel() %>% 
    prune(alpha = 0.05, recursive = TRUE) %>% # iterative process pruning non-significant parameters and refitting model
    modelsearch(
      criterion = 'bic', # optimal model with smallest BIC
      prunealpha = 0.05, # min alpha, larger edges will be removed
      addalpha = 0.05, # max alpha, smaller edges will be added
    )

  
  save(networkmodel_ammsa_final, file = './rda/ammsa_networkmodel.rda')
  
  
} else {
  
  load('./rda/ammsa_networkmodel.rda')
  
}



fit_networkmodel_ammsa <- fit(networkmodel_ammsa_final) # fit indices

pars_networkmodel_ammsa <- parameters(networkmodel_ammsa_final) # all parameters

```


## Graph Network Model AMMSA
```{r}

network_ammsa <- getmatrix(
  networkmodel_ammsa_final, 
  'omega')


graph_network_ammsa <- qgraph(network_ammsa,
                              layout = 'spring',
                              theme = 'colorblind',
                              title = 'AMMSA-21 Network Model',
                              labels = 1:21, 
                              edge.labels = TRUE,
                              vsize = 4,
                              shape = 'circle',
                              filetype = 'pdf',
                              filename = 'ammsa_network')


```


## Node Centrality 

### Centrality Plot
```{r}

graph_centrality_network_ammsa <- qgraph::centralityPlot(
  graph_network_ammsa,
  include = c('Strength', 'Closeness', 'Betweenness'))

```


### Strength
```{r}

network_strength_ammsa <- graph_centrality_network_ammsa$data %>% # take qgraph data
  filter(measure == 'Strength') %>% # take strength data
  arrange(desc(value)) %>% # arrange largest value first
  mutate(
    node = as.numeric(node)
  )
  
```


### Betweenness
```{r}

network_between_ammsa <- graph_centrality_network_ammsa$data %>% 
  filter(measure == "Betweenness") %>% 
  arrange(desc(value)) %>% 
  mutate(
    node = as.numeric(node)
  )

```


## Network Connectivity (ASPL)
```{r}

spl_network_ammsa <- centrality(graph_network_ammsa)$ShortestPathLengths

spl_network_ammsa <- spl_network_ammsa[upper.tri(spl_network_ammsa)]
aspl_network_ammsa <- mean(spl_network_ammsa)

```


## Communities/Clusters
```{r}

# how many 'factors' would I have?

parallel_ammsa <- fa.parallel(data_ammsa)

```


```{r}

set.seed(4321)

# exploratory graph analysis

ega_ammsa <-EGAnet::EGA(data_ammsa,
                        model = 'glasso',
                        algorithm = 'walktrap',
                        plot.EGA = TRUE,
                        )


```


# Network Model Sakaluk
```{r}

data_sakaluk <- data_hetero_malefemale %>% 
  select(
    starts_with('sexualstandards'), 
    starts_with('complexity'), 
    starts_with('sexdrive'), 
    starts_with('performanceandorgasm'), 
    starts_with('player'), 
    starts_with('emotionalsex')
  )


if (!file.exists('./rda/sakaluk_networkmodel.rda')) {
  
  # model the variance-covariance matrix
  networkmodel_sakaluk <- varcov(data = data_sakaluk,
                                 type = 'ggm', # Gaussian graphical model
                                 omega = 'full') # estimate every element freely


  # run model and estimate structure --> time consuming
  networkmodel_sakaluk_final <- networkmodel_sakaluk %>% 
    runmodel() %>% 
    prune(alpha = 0.05, recursive = TRUE) %>% # iterative process pruning non-significant parameters and refitting model
    modelsearch(
      criterion = 'bic', # optimal model with smallest BIC
      prunealpha = 0.05, # min alpha, larger edges will be removed
      addalpha = 0.05, # max alpha, smaller edges will be added
    )

  
  save(networkmodel_sakaluk_final, file = './rda/sakaluk_networkmodel.rda')
  
  
} else {
  
  load('./rda/sakaluk_networkmodel.rda')
  
}



fit_networkmodel_sakaluk <- fit(networkmodel_sakaluk_final) # fit indices

pars_networkmodel_sakaluk <- parameters(networkmodel_sakaluk_final) # all parameters

```


## Graph Network Model Sakaluk
```{r}

labels_sakaluk <- c(
  'sexst_1',
  'sexst_2',
  'sexst_3',
  'sexst_4',
  'sexst_5',
  'sexst_6',
  'sexst_7',
  'sexst_8',
  'sexst_9',
  'comp_1',
  'comp_2',
  'comp_3',
  'comp_4',
  'comp_5',
  'comp_6',
  'comp_7',
  'sexd_1',
  'sexd_2',
  'sexd_3',
  'sexd_4',
  'sexd_5',
  'perf_1',
  'perf_2',
  'perf_3',
  'perf_4',
  'play_1',
  'play_2',
  'play_3',
  'play_4',
  'emse_1',
  'emse_2',
  'emse_3'
)


network_sakaluk <- getmatrix(
  networkmodel_sakaluk_final, 
  'omega')


graph_network_sakaluk <- qgraph(network_sakaluk,
                                layout = 'spring',
                                theme = 'colorblind',
                                title = 'Network Model Sexual Scripts by Sakaluk et al. (2014)',
                                labels = labels_sakaluk, 
                                edge.labels = TRUE,
                                vsize = 5,
                                shape = 'circle',
                                filetype = 'pdf',
                                filename = 'sakaluk_network')

```


## Node Centrality 

### Centrality Plot
```{r}

graph_centrality_network_sakaluk <- qgraph::centralityPlot(
  graph_network_sakaluk,
  include = c('Strength', 'Closeness', 'Betweenness'))

```


### Strength
```{r}

network_strength_sakaluk <- graph_centrality_network_sakaluk$data %>% # take qgraph data
  filter(measure == 'Strength') %>% # take strength data
  arrange(desc(value)) %>% # arrange largest value first
  mutate(
    node = as.numeric(node)
  )

```


### Betweenness
```{r}

network_between_sakaluk <- graph_centrality_network_sakaluk$data %>% 
  filter(measure == "Betweenness") %>% 
  arrange(desc(value)) %>% 
  mutate(
    node = as.numeric(node)
  )

```


## Network Connectivity (ASPL)
```{r}

spl_network_sakaluk <- centrality(graph_network_sakaluk)$ShortestPathLengths

spl_network_sakaluk <- spl_network_sakaluk[upper.tri(spl_network_sakaluk)]
aspl_network_sakaluk <- mean(spl_network_sakaluk)

```


## Communities/Clusters
```{r}

# how many 'factors' would I have?

parallel_sakaluk <- fa.parallel(data_sakaluk)

```


```{r}

set.seed(5432)

# exploratory graph analysis

ega_sakaluk <-EGAnet::EGA(data_sakaluk,
                        model = 'glasso',
                        algorithm = 'walktrap',
                        plot.EGA = TRUE)

```


# Network Model Seabrook
```{r}

data_seabrook <- data_hetero_malefemale %>% 
  select(
    starts_with('courtship'), 
    starts_with('initiators'), 
    starts_with('appearance'), 
    starts_with('doublestandards')
  )


if (!file.exists('./rda/seabrook_networkmodel.rda')) {
  
  # model the variance-covariance matrix
  networkmodel_seabrook <- varcov(data = data_seabrook,
                                 type = 'ggm', # Gaussian graphical model
                                 omega = 'full') # estimate every element freely


  # run model and estimate structure --> time consuming
  networkmodel_seabrook_final <- networkmodel_seabrook %>% 
    runmodel() %>% 
    prune(alpha = 0.05, recursive = TRUE) %>% # iterative process pruning non-significant parameters and refitting model
    modelsearch(
      criterion = 'bic', # optimal model with smallest BIC
      prunealpha = 0.05, # min alpha, larger edges will be removed
      addalpha = 0.05, # max alpha, smaller edges will be added
    )

  
  save(networkmodel_seabrook_final, file = './rda/seabrook_networkmodel.rda')
  
  
} else {
  
  load('./rda/seabrook_networkmodel.rda')
  
}



fit_networkmodel_seabrook <- fit(networkmodel_seabrook_final) # fit indices

pars_networkmodel_seabrook <- parameters(networkmodel_seabrook_final) # all parameters

```


## Graph Network Model Seabrook
```{r}

labels_seabrook <- c(
  'cour_1',
  'cour_2',
  'cour_3',
  'cour_4',
  'cour_5',
  'cour_6',
  'cour_7',
  'cour_8',
  'init_1',
  'init_2',
  'init_3',
  'init_4',
  'appe_1',
  'appe_2',
  'appe_3',
  'appe_4',
  'appe_5',
  'dost_1',
  'dost_2',
  'dost_3',
  'dost_4',
  'dost_5'
)


network_seabrook <- getmatrix(
  networkmodel_seabrook_final, 
  'omega')


graph_network_seabrook <- qgraph(network_seabrook,
                                layout = 'spring',
                                theme = 'colorblind',
                                title = 'Network Model Sexual Scripts by Seabrook et al. (2016)',
                                labels = labels_seabrook, 
                                edge.labels = TRUE,
                                vsize = 5,
                                shape = 'circle',
                                filetype = 'pdf',
                                filename = 'seabrook_network')

```


## Node Centrality 

### Centrality Plot
```{r}

graph_centrality_network_seabrook <- qgraph::centralityPlot(
  graph_network_seabrook,
  include = c('Strength', 'Closeness', 'Betweenness'))

```


### Strength
```{r}

network_strength_seabrook <- graph_centrality_network_seabrook$data %>% # take qgraph data
  filter(measure == 'Strength') %>% # take strength data
  arrange(desc(value)) %>% # arrange largest value first
  mutate(
    node = as.numeric(node)
  )

```


### Betweenness
```{r}

network_between_seabrook <- graph_centrality_network_seabrook$data %>% 
  filter(measure == "Betweenness") %>% 
  arrange(desc(value)) %>% 
  mutate(
    node = as.numeric(node)
  )

```


## Network Connectivity (ASPL)
```{r}

spl_network_seabrook <- centrality(graph_network_seabrook)$ShortestPathLengths

spl_network_seabrook <- spl_network_seabrook[upper.tri(spl_network_seabrook)]
aspl_network_seabrook <- mean(spl_network_seabrook)

```


## Communities/Clusters
```{r}

# how many 'factors' would I have?

parallel_seabrook <- fa.parallel(data_seabrook)

```


```{r}

set.seed(6543)

# exploratory graph analysis

ega_seabrook <-EGAnet::EGA(data_seabrook,
                           model = 'glasso',
                           algorithm = 'walktrap',
                           plot.EGA = TRUE)

```


# Network Model Krahé
```{r}

data_krahe <- data_hetero_malefemale %>% 
  select(
    starts_with('arranged'), 
    starts_with('situation'), 
    starts_with('sex_'), 
    starts_with('sexlocation'), 
    starts_with('contraception'), 
    'metbefore', 
    'knownbefore',
    starts_with('substances'), 
    starts_with('drunkstoned'), 
    starts_with('consentgirl'),
    starts_with('consentboy'),
    starts_with('afterfeeling'), 
    starts_with('outlook')
  )


if (!file.exists('./rda/krahe_networkmodel.rda')) {
  
  # model the variance-covariance matrix
  networkmodel_krahe <- varcov(data = data_krahe,
                                 type = 'ggm', # Gaussian graphical model
                                 omega = 'full') # estimate every element freely


  # run model and estimate structure --> time consuming
  networkmodel_krahe_final <- networkmodel_krahe %>% 
    runmodel() %>% 
    prune(alpha = 0.05, recursive = TRUE) %>% # iterative process pruning non-significant parameters and refitting model
    modelsearch(
      criterion = 'bic', # optimal model with smallest BIC
      prunealpha = 0.05, # min alpha, larger edges will be removed
      addalpha = 0.05, # max alpha, smaller edges will be added
    )

  
  save(networkmodel_krahe_final, file = './rda/krahe_networkmodel.rda')
  
  
} else {
  
  load('./rda/krahe_networkmodel.rda')
  
}



fit_networkmodel_krahe <- fit(networkmodel_krahe_final) # fit indices

pars_networkmodel_krahe <- parameters(networkmodel_krahe_final) # all parameters

```


## Graph Network Model Krahé
```{r}

labels_krahe <- c(
  'arra_1',
  'situ_1',
  'situ_2',
  'situ_3',
  'sex_1',
  'sex_2',
  'sex_3',
  'sex_4',
  'sex_5',
  'sexlo_1',
  'sexlo_2',
  'sexlo_3',
  'sexlo_4',
  'sexlo_5',
  'sexlo_6',
  'cont_1',
  'cont_2',
  'cont_3',
  'cont_4',
  'cont_5',
  'met_1',
  'known_1',
  'subst_1',
  'subst_2',
  'subst_3',
  'subst_4',
  'drunk_1',
  'drunk_2',
  'cboy_1',
  'cboy_2',
  'cgirl_1',
  'cgirl_2',
  'after_1',
  'after_2',
  'outg_1',
  'outg_2',
  'outg_3',
  'outb_1',
  'outb_2',
  'outb_3'
)


network_krahe <- getmatrix(
  networkmodel_krahe_final, 
  'omega')


graph_network_krahe <- qgraph(network_krahe,
                                layout = 'spring',
                                theme = 'colorblind',
                                title = 'Network Model Sexual Scripts by Krahé et al. (2007)',
                                labels = labels_krahe, 
                                edge.labels = TRUE,
                                vsize = 5,
                                shape = 'circle',
                                filetype = 'pdf',
                                filename = 'krahe_network')

```


## Node Centrality 

### Centrality Plot
```{r}

graph_centrality_network_krahe <- qgraph::centralityPlot(
  graph_network_krahe,
  include = c('Strength', 'Closeness', 'Betweenness'))

```


### Strength
```{r}

network_strength_krahe <- graph_centrality_network_krahe$data %>% # take qgraph data
  filter(measure == 'Strength') %>% # take strength data
  arrange(desc(value)) %>% # arrange largest value first
  mutate(
    node = as.numeric(node)
  )

```


### Betweenness
```{r}

network_between_krahe <- graph_centrality_network_krahe$data %>% 
  filter(measure == "Betweenness") %>% 
  arrange(desc(value)) %>% 
  mutate(
    node = as.numeric(node)
  )

```


## Network Connectivity (ASPL)
```{r}

spl_network_krahe <- centrality(graph_network_krahe)$ShortestPathLengths

spl_network_krahe <- spl_network_krahe[upper.tri(spl_network_krahe)]
aspl_network_krahe <- mean(spl_network_krahe)

```


## Communities/Clusters
```{r}

# how many 'factors' would I have?

parallel_krahe <- fa.parallel(data_krahe)


```


```{r}

set.seed(7654)

# exploratory graph analysis

ega_krahe <-EGAnet::EGA(data_krahe,
                           model = 'glasso',
                           algorithm = 'walktrap',
                           plot.EGA = TRUE)

ega_krahe$dim.variables

```


###################################################################################

